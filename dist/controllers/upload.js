var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,a){void 0===a&&(a=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,a,n)}:function(e,t,i,a){e[a=void 0===a?i:a]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||(()=>{var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var t,i=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[i.length]=t);return i})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=n(e),a=0;a<i.length;a++)"default"!==i[a]&&__createBinding(t,e,i[a]);return __setModuleDefault(t,e),t}})(),__awaiter=this&&this.__awaiter||function(e,l,f,o){return new(f=f||Promise)(function(i,t){function a(e){try{r(o.next(e))}catch(e){t(e)}}function n(e){try{r(o.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?i(e.value):((t=e.value)instanceof f?t:new f(function(e){e(t)})).then(a,n)}r((o=o.apply(e,l||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=uploadRoute;let fastify_multer_1=__importDefault(require("fastify-multer")),path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),mime=require("mime-types");function uploadRoute(_){return __awaiter(this,void 0,void 0,function*(){yield _.register(Promise.resolve().then(()=>__importStar(require("@fastify/multipart"))));var e=fastify_multer_1.default.diskStorage({destination:function(e,t,i){i(null,"uploads/")},filename:function(e,t,i){t=path_1.default.extname(t.originalname);i(null,""+Date.now()+t)}}),t=(0,fastify_multer_1.default)({storage:e}),e=(0,fastify_multer_1.default)({storage:e,fileFilter:function(e,t,i){if("image/*"!==t.mimetype)return i(new Error("Only PNG files are allowed"),!1);i(null,!0)},limits:{fileSize:10485760}});_.get("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){return{data:"upload ready"}})),_.post("/file",{preHandler:t.single("file")},(r,l)=>__awaiter(this,void 0,void 0,function*(){var e=r.file,{originalname:t,filename:i,mimetype:a,size:n}=e;return yield(yield _.mysql.fastifyBasic.getConnection()).query(`
        INSERT INTO files (file_origianalname, file_name, mimetype, size, file_path) 
        VALUES (?, ?, ?, ?, ?)`,[t,i,a,n,"http://127.0.0.1:8000/uploads/"+i]),l.send({message:"File uploaded successfully",data:e})})),_.post("/files",{preHandler:t.array("file",4)},(s,d)=>__awaiter(this,void 0,void 0,function*(){var e,t=s.files,i=yield _.mysql.fastifyBasic.getConnection(),a=[];for(e of t){var{originalname:n,filename:r,mimetype:l,size:f}=e,o="http://127.0.0.1:8000/uploads/"+r,[u]=yield i.query(`
        INSERT INTO files (file_origianalname, file_name, mimetype, size, file_path) 
        VALUES (?, ?, ?, ?, ?)`,[n,r,l,f,o]);a.push({id:u.insertId,originalname:n,filename:r,mimetype:l,size:f,filePath:o})}return d.send({message:"Files uploaded successfully",data:a})})),_.post("/fileFix",{preHandler:e.single("file")},(e,t)=>__awaiter(this,void 0,void 0,function*(){return{data:e.file}})),_.get("/file/:fileName",(i,a)=>__awaiter(this,void 0,void 0,function*(){var e=i.params.fileName,t=path_1.default.join("uploads/",e),e=mime.lookup(e),t=fs_1.default.readFileSync(t);a.header("Content-Type",e),a.send(t)})),_.delete("/file/:id",(r,l)=>__awaiter(this,void 0,void 0,function*(){var e=r.params.id,t=yield _.mysql.fastifyBasic.getConnection();try{var i,a,[n]=yield t.query("SELECT file_name FROM files WHERE file_id = ?",[e]);return n&&0!==n.length?(i=n[0].file_name,a=path_1.default.join("uploads/",i),fs_1.default.existsSync(a)&&fs_1.default.unlinkSync(a),yield t.query("DELETE FROM files WHERE file_id = ?",[e]),l.send({message:"File deleted successfully",id:e,fileName:i})):l.status(404).send({message:"File not found"})}catch(e){return l.status(500).send({message:"Error deleting file",error:e})}finally{t.release()}}))})}
//# sourceMappingURL=upload.js.map
