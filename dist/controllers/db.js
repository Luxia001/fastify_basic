var __awaiter=this&&this.__awaiter||function(e,n,d,o){return new(d=d||Promise)(function(s,t){function a(e){try{r(o.next(e))}catch(e){t(e)}}function i(e){try{r(o.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof d?t:new d(function(e){e(t)})).then(a,i)}r((o=o.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=dbRoute;let bcryptjs_1=__importDefault(require("bcryptjs"));function dbRoute(d){return __awaiter(this,void 0,void 0,function*(){d.get("/users",(e,t)=>__awaiter(this,void 0,void 0,function*(){var[e]=yield(yield d.mysql.fastifyBasic.getConnection()).query("SELECT * FROM users");return{data:e}})),d.get("/imnight",(e,t)=>__awaiter(this,void 0,void 0,function*(){var[e]=yield(yield d.mysql.imNight.getConnection()).query("SELECT * FROM menu");return{data:e}})),d.post("/register",{schema:{headers:{},params:{},query:{},body:{type:"object",required:["fristName","lastName","username","password"],properties:{fristName:{type:"string"},lastName:{type:"string"},username:{type:"string",maxLength:20},password:{type:"string",minLength:6}}}}},(r,e)=>__awaiter(this,void 0,void 0,function*(){var{fristName:e,lastName:t,username:s,password:a}=r.body,i=yield d.mysql.fastifyBasic.getConnection(),a=yield bcryptjs_1.default.hash(a,10);return yield i.query("INSERT INTO users (frist_name,last_name,username, password) VALUES (?, ?, ?, ?)",[e,t,s,a]),{data:"register success"}})),d.post("/login",{schema:{headers:{},params:{},query:{},body:{type:"object",required:["username","password"],properties:{username:{type:"string",maxLength:20},password:{type:"string",minLength:6}}}}},(s,e)=>__awaiter(this,void 0,void 0,function*(){var{username:e,password:t}=s.body,[e]=yield(yield d.mysql.fastifyBasic.getConnection()).query("SELECT * FROM users WHERE username = ?",[e]);return 0===e.length?{data:"user not found"}:(yield bcryptjs_1.default.compare(t,e[0].password))?{data:"login success",token:d.jwt.sign({id:e[0].id,fristName:e[0].frist_name,lastName:e[0].last_name})}:{data:"password not match"}})),d.get("/getUser/:id",{preValidation:[d.authenticate]},(t,e)=>__awaiter(this,void 0,void 0,function*(){var e=t.params.id,[e]=yield(yield d.mysql.fastifyBasic.getConnection()).query("SELECT * FROM users WHERE id = ?",[e]);return{data:e[0]}})),d.put("/updateUser",{schema:{headers:{},params:{},query:{},body:{type:"object",required:["id"],properties:{id:{type:"integer"},fristName:{type:"string"},lastName:{type:"string"},username:{type:"string",maxLength:20},password:{type:"string",minLength:6}}}}},(n,e)=>__awaiter(this,void 0,void 0,function*(){var{id:e,fristName:t,lastName:s,username:a,password:i}=n.body,r=yield d.mysql.fastifyBasic.getConnection(),i=yield bcryptjs_1.default.hash(i,10);return yield r.query("UPDATE users SET frist_name = ?, last_name = ?,username=?,password=? WHERE id = ?",[t,s,a,i,e]),{data:"update success"}})),d.delete("/deleteUser/:id",{schema:{headers:{},params:{type:"object",required:["id"],properties:{id:{type:"integer"}}},query:{},body:{}}},(t,e)=>__awaiter(this,void 0,void 0,function*(){var e=t.params.id;return yield(yield d.mysql.fastifyBasic.getConnection()).query("DELETE FROM users WHERE id = ?",[e]),{data:"delete success"}}))})}
//# sourceMappingURL=db.js.map
